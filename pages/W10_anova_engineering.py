# W10_anova_engineering.py
# ANOVA æŸ¥è¡¨å°å‘ç‰ˆ

import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from scipy.stats import f

st.set_page_config(layout="wide")
st.title("ç¬¬ 10 é€±ï½œANOVA å¤šæ–¹æ¡ˆæ¯”è¼ƒï¼ˆæŸ¥è¡¨å°å‘ç‰ˆï¼‰")
st.caption("ğŸ“˜ æ•™ç§‘æ›¸ç¬¬ 9 ç« ï½œé‡é»ï¼šæŸ¥è¡¨åˆ¤æ–· F å€¼")

# =================================================
# A. å­¸ç¿’æ¨¡å¼
# =================================================
st.sidebar.header("å­¸ç¿’æ¨¡å¼")
mode = st.sidebar.radio(
    "æ¨¡å¼",
    ["ğŸ” æŸ¥è¡¨ç·´ç¿’æ¨¡å¼ï¼ˆèª²å ‚ï¼‰", "âš¡ è‡ªå‹•é©—è­‰æ¨¡å¼ï¼ˆèª²å¾Œï¼‰"]
)

st.markdown("""
å·¥ç¨‹ç¾å ´ç¶“å¸¸æœ‰ä¸‰å€‹ä»¥ä¸Šæ–¹æ¡ˆã€‚  
ä»Šå¤©æˆ‘å€‘ä¸ç›´æ¥ç”¨ç¨‹å¼åˆ¤æ–·ï¼Œè€Œæ˜¯**æŸ¥ F è¡¨**æ±ºå®šæ‹’çµ•åŸŸã€‚
""")

# =================================================
# B. å·¥ç¨‹æ¡ˆä¾‹é¸æ“‡
# =================================================
st.subheader("ä¸€ã€å·¥ç¨‹æ¡ˆä¾‹")
case = st.selectbox(
    "é¸æ“‡å·¥ç¨‹æƒ…å¢ƒ",
    ["å¡åœ°æ’æ°´é…ç½®æ¯”è¼ƒ", "ä¸åŒå·¥æ³•æ–½å·¥æ™‚é–“", "ææ–™ä¾†æºå“è³ªå·®ç•°"]
)

np.random.seed(42)

if case == "å¡åœ°æ’æ°´é…ç½®æ¯”è¼ƒ":
    unit = "mm"
    group_A = np.random.normal(3.2, 0.4, 20)
    group_B = np.random.normal(2.9, 0.4, 20)
    group_C = np.random.normal(2.5, 0.4, 20)
    ylabel = "å¡é¢ä½ç§»"
elif case == "ä¸åŒå·¥æ³•æ–½å·¥æ™‚é–“":
    unit = "åˆ†é˜"
    group_A = np.random.normal(30, 3, 25)
    group_B = np.random.normal(27, 3, 25)
    group_C = np.random.normal(26, 3, 25)
    ylabel = "æ–½å·¥æ™‚é–“"
else:
    unit = "åˆæ ¼ç‡"
    group_A = np.random.normal(0.88, 0.03, 30)
    group_B = np.random.normal(0.91, 0.03, 30)
    group_C = np.random.normal(0.93, 0.03, 30)
    ylabel = "å“è³ªæŒ‡æ¨™"

groups = [group_A, group_B, group_C]

# =================================================
# C. é¡¯è‘—æ°´æº–
# =================================================
st.subheader("äºŒã€é¡¯è‘—æ°´æº–")
alpha = st.selectbox("é¡¯è‘—æ°´æº– Î±", [0.10, 0.05, 0.01], index=1)

# =================================================
# D. è¨ˆç®— df1, df2
# =================================================
k = len(groups)
n_list = [len(g) for g in groups]
N = sum(n_list)
df1 = k - 1
df2 = N - k
st.write(f"è‡ªç”±åº¦ df1 = {df1}, df2 = {df2}")

# =================================================
# E. è¨ˆç®— F çµ±è¨ˆé‡
# =================================================
grand_mean = np.mean(np.concatenate(groups))
SSB = sum([len(g)*(np.mean(g)-grand_mean)**2 for g in groups])
SSW = sum([sum((g-np.mean(g))**2) for g in groups])
MSB = SSB/df1
MSW = SSW/df2
F_stat = MSB/MSW
st.write(f"è¨ˆç®— F çµ±è¨ˆé‡ = {F_stat:.3f}")

# =================================================
# F. æŸ¥è¡¨è¼¸å…¥
# =================================================
st.subheader("ä¸‰ã€æŸ¥è¡¨åˆ¤æ–·")

st.markdown("""
ğŸ“˜ è«‹æ‰“é–‹ F è¡¨  
- df1 = çµ„é–“è‡ªç”±åº¦  
- df2 = çµ„å…§è‡ªç”±åº¦  
- é¡¯è‘—æ°´æº– Î±  

è¼¸å…¥ F è‡¨ç•Œå€¼
""")

F_input = st.number_input("è«‹è¼¸å…¥ F è‡¨ç•Œå€¼ FÎ±(df1, df2)", value=3.10, step=0.01)

# =================================================
# G. åˆ¤æ–·æ‹’çµ•åŸŸ
# =================================================
st.subheader("å››ã€å·¥ç¨‹åˆ¤æ–·")

if F_stat > F_input:
    st.success("âœ… F å€¼è¶…éè‡¨ç•Œå€¼ â†’ æ‹’çµ• Hâ‚€\nè‡³å°‘æœ‰ä¸€æ–¹æ¡ˆä¸åŒ")
else:
    st.warning("âš ï¸ F å€¼æœªè¶…éè‡¨ç•Œå€¼ â†’ ç„¡æ³•æ‹’çµ• Hâ‚€\nå·®ç•°å¯èƒ½åªæ˜¯èª¤å·®")

# =================================================
# H. è¦–è¦ºåŒ–
# =================================================
st.subheader("äº”ã€è¦–è¦ºåŒ–")

fig, ax = plt.subplots()
ax.boxplot(groups, labels=["æ–¹æ¡ˆ A","æ–¹æ¡ˆ B","æ–¹æ¡ˆ C"])
ax.set_ylabel(f"{ylabel} ({unit})")
ax.set_title("å„æ–¹æ¡ˆè³‡æ–™åˆ†å¸ƒèˆ‡æ¯”è¼ƒ")
st.pyplot(fig)

# =================================================
# I. å·¥ç¨‹åæ€
# =================================================
st.subheader("å…­ã€å·¥ç¨‹åæ€")

st.markdown("""
1. F å€¼å¤§æ–¼è‡¨ç•Œå€¼ï¼Œä»£è¡¨ä»€éº¼ï¼Ÿ  
2. å·®ç•°çµ±è¨ˆé¡¯è‘— â‰  å·®ç•°å·¥ç¨‹ä¸Šé‡è¦  
3. å¦‚ä½•çµåˆå·¥ç¨‹å®‰å…¨é–€æª»ä¾†é¸æ–¹æ¡ˆï¼Ÿ
""")

st.info("""
ğŸ“Œ æœ¬é€±é‡é»ï¼šæŸ¥ F è¡¨ â†’ åˆ¤æ–·å·®ç•° â†’ åšå·¥ç¨‹æ±ºç­–  
ğŸ“Œ çµ±è¨ˆåªæ˜¯å·¥å…·ï¼Œå·¥ç¨‹åˆ¤æ–·æ‰æ˜¯æ ¸å¿ƒ
""")
