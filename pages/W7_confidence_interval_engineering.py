# W7_confidence_interval_engineering.py
# æŸ¥è¡¨å°å‘ç‰ˆ

import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from scipy.stats import t

st.set_page_config(layout="wide")
st.title("ç¬¬ 7 é€±ï½œä¿¡è³´å€é–“ï¼ˆå·¥ç¨‹æŸ¥è¡¨è¨“ç·´ï¼‰")
st.caption("ğŸ“˜ æ•™ç§‘æ›¸ç¬¬ 7 ç« ï½œé‡é»ï¼šæœƒç”¨ t è¡¨")

# =================================================
# A. å­¸ç¿’æ¨¡å¼
# =================================================
st.sidebar.header("å­¸ç¿’æ¨¡å¼")

mode = st.sidebar.radio(
    "é¸æ“‡æ¨¡å¼",
    ["ğŸ” æŸ¥è¡¨ç·´ç¿’æ¨¡å¼ï¼ˆèª²å ‚ï¼‰", "âš¡ è‡ªå‹•é©—è­‰æ¨¡å¼ï¼ˆèª²å¾Œï¼‰"]
)

st.markdown("""
å·¥ç¨‹ä¸æ˜¯åªå•ã€Œå¹³å‡æ˜¯å¤šå°‘ã€ï¼Œ  
è€Œæ˜¯å• **ã€Œæˆ‘æœ‰å¤šå¤§çš„æŠŠæ¡ä¸æœƒå‡ºäº‹ï¼Ÿã€**
""")

# =================================================
# B. å·¥ç¨‹æ¡ˆä¾‹é¸æ“‡
# =================================================
st.subheader("ä¸€ã€å·¥ç¨‹æ¡ˆä¾‹")

case = st.selectbox(
    "é¸æ“‡å·¥ç¨‹æƒ…å¢ƒ",
    ["å¡åœ°ä½ç§»ç›£æ¸¬", "å–®å ´é™é›¨é‡"]
)

np.random.seed(42)

if case == "å¡åœ°ä½ç§»ç›£æ¸¬":
    true_mean = 2.6
    sigma = 0.5
    unit = "mm"
    safety_limit = 3.0
    population = np.random.normal(true_mean, sigma, 300)

else:
    true_mean = 120
    sigma = 25
    unit = "mm"
    safety_limit = 150
    population = np.random.normal(true_mean, sigma, 300)

# =================================================
# C. æŠ½æ¨£
# =================================================
st.subheader("äºŒã€ä½ å¯¦éš›é‡æ¸¬åˆ°çš„è³‡æ–™")

sample_size = st.slider("æ¨£æœ¬æ•¸ n", 5, 50, 12)
sample = np.random.choice(population, sample_size, replace=False)

xbar = np.mean(sample)
s = np.std(sample, ddof=1)
df = sample_size - 1

st.write(f"""
- æ¨£æœ¬å¹³å‡ = **{xbar:.3f} {unit}**  
- æ¨£æœ¬æ¨™æº–å·® = **{s:.3f}**  
- è‡ªç”±åº¦ df = **{df}**
""")

# =================================================
# D. ä¿¡è³´æ°´æº–
# =================================================
st.subheader("ä¸‰ã€ä½ è¦å¤šä¿å®ˆï¼Ÿ")

confidence = st.selectbox(
    "ä¿¡è³´æ°´æº–",
    [0.90, 0.95, 0.99],
    index=1
)

alpha = 1 - confidence

st.write(f"""
ğŸ‘‰ Î± = {alpha}  
ğŸ‘‰ Î± / 2 = {alpha/2}
""")

st.markdown("""
ğŸ“˜ **è«‹æŸ¥ t è¡¨**  
ä¾æ“šï¼š
- df  
- Î±/2
""")

# =================================================
# E. æŸ¥è¡¨è¼¸å…¥ï¼ˆæ ¸å¿ƒï¼‰
# =================================================
t_input = st.number_input(
    "è«‹è¼¸å…¥ä½ æŸ¥åˆ°çš„ tÎ±/2, df",
    value=2.0,
    step=0.01
)

# =================================================
# F. ä¿¡è³´å€é–“è¨ˆç®—ï¼ˆç”¨å­¸ç”Ÿè¼¸å…¥çš„ tï¼‰
# =================================================
margin = t_input * s / np.sqrt(sample_size)
lower = xbar - margin
upper = xbar + margin

# =================================================
# G. è¦–è¦ºåŒ–
# =================================================
st.subheader("å››ã€ä¿¡è³´å€é–“è¦–è¦ºåŒ–")

fig, ax = plt.subplots()

ax.axvline(safety_limit, color="red", linestyle="--", label="å·¥ç¨‹å®‰å…¨é–€æª»")
ax.hlines(1, lower, upper, color="blue", linewidth=4, label="ä¿¡è³´å€é–“")
ax.plot(xbar, 1, "o", label="æ¨£æœ¬å¹³å‡")

ax.set_yticks([])
ax.set_xlabel(f"{unit}")
ax.legend()
st.pyplot(fig)

# =================================================
# H. é©—è­‰ï¼ˆèª²å¾Œæ‰é¡¯ç¤ºï¼‰
# =================================================
t_true = t.ppf(1 - alpha / 2, df)

if mode == "âš¡ è‡ªå‹•é©—è­‰æ¨¡å¼ï¼ˆèª²å¾Œï¼‰":
    st.write(f"ğŸ“Œ æ­£ç¢º t å€¼ â‰ˆ **{t_true:.3f}**")

    if abs(t_input - t_true) < 0.05:
        st.success("âœ… æŸ¥è¡¨æ­£ç¢º")
    else:
        st.warning("âš ï¸ è«‹é‡æ–°ç¢ºèª df æˆ– Î±/2")

else:
    st.info("""
ğŸ“Œ èª²å ‚æ¨¡å¼ä¸é¡¯ç¤ºæ­£ç¢º t å€¼  
ğŸ“Œ è€å¸«æœƒè«‹ä½ è§£é‡‹ï¼š
- ç‚ºä»€éº¼é¸é€™å€‹ä¿¡è³´æ°´æº–ï¼Ÿ
- ç‚ºä»€éº¼ç”¨é€™å€‹ tï¼Ÿ
""")

# =================================================
# I. å·¥ç¨‹åˆ¤æ–·
# =================================================
st.subheader("äº”ã€å·¥ç¨‹åˆ¤æ–·")

if lower <= safety_limit <= upper:
    st.warning("""
âš ï¸ ä¿¡è³´å€é–“è·¨è¶Šå®‰å…¨é–€æª»  
ğŸ‘‰ åœ¨æ­¤ä¿å®ˆç¨‹åº¦ä¸‹ï¼Œä»æœ‰é¢¨éšª
""")
else:
    st.success("""
âœ… ä¿¡è³´å€é–“æœªè·¨è¶Šå®‰å…¨é–€æª»  
ğŸ‘‰ åœ¨æ­¤ä¿å®ˆç¨‹åº¦ä¸‹ï¼Œå¯æ¥å—
""")

st.warning("""
è«‹è¨˜ä½ï¼š  
**æ˜¯ä½ é¸æ“‡äº†é€™å€‹ä¿¡è³´æ°´æº–ï¼Œ  
ä¸æ˜¯çµ±è¨ˆæ›¿ä½ é¸çš„ã€‚**
""")
