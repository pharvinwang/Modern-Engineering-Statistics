# W7_confidence_interval_engineering.py

import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from scipy.stats import t

st.set_page_config(layout="wide")
st.title("ç¬¬ 7 é€±ï½œä¼°è¨ˆèˆ‡ä¿¡è³´å€é–“ï¼šå·¥ç¨‹æ•¢ä¸æ•¢ç”¨ï¼Ÿ")
st.caption("ğŸ“˜ æ•™ç§‘æ›¸ç¬¬ 7 ç« ï¼ˆ7.1â€“7.3 ç‚ºä¸»ï¼‰")

st.markdown("""
å·¥ç¨‹çµ±è¨ˆçœŸæ­£è¢«å·¥ç¨‹å¸«ä½¿ç”¨çš„åœ°æ–¹ï¼Œ  
ä¸æ˜¯å¹³å‡å€¼ï¼Œè€Œæ˜¯ **ä¿¡è³´å€é–“**ã€‚

ğŸ‘‰ å®ƒå›ç­”çš„ä¸æ˜¯ã€Œæ˜¯å¤šå°‘ã€ï¼Œ  
ğŸ‘‰ è€Œæ˜¯ã€Œä½ æœ‰å¤šå¤§çš„æŠŠæ¡ã€ã€‚
""")

# =================================================
# A. å·¥ç¨‹æƒ…å¢ƒé¸æ“‡
# =================================================
st.subheader("ä¸€ã€å·¥ç¨‹æƒ…å¢ƒ")

case = st.selectbox(
    "é¸æ“‡å·¥ç¨‹æ¡ˆä¾‹",
    ["å¡åœ°ä½ç§»ç›£æ¸¬", "å–®å ´é™é›¨é‡", "æ–½å·¥å“è³ªåˆæ ¼ç‡"]
)

# =================================================
# B. æ¨¡æ“¬å·¥ç¨‹è³‡æ–™ï¼ˆå»¶çºŒå‰å¹¾é€±ï¼‰
# =================================================
np.random.seed(42)

if case == "å¡åœ°ä½ç§»ç›£æ¸¬":
    true_mean = 2.5
    sigma = 0.6
    unit = "mm"
    safety_limit = 3.0
    data = np.random.normal(true_mean, sigma, 200)

elif case == "å–®å ´é™é›¨é‡":
    true_mean = 120
    sigma = 25
    unit = "mm"
    safety_limit = 150
    data = np.random.normal(true_mean, sigma, 200)

else:
    true_p = 0.92
    unit = "%"
    safety_limit = 0.95
    data = np.random.binomial(1, true_p, 200)

# =================================================
# C. æ¨£æœ¬è¨­å®š
# =================================================
st.subheader("äºŒã€ä½ å¯¦éš›å–å¾—çš„è³‡æ–™")

sample_size = st.slider("æ¨£æœ¬æ•¸ n", 5, 100, 20)
sample = np.random.choice(data, sample_size, replace=False)

# =================================================
# D. ä¿¡è³´æ°´æº–
# =================================================
st.subheader("ä¸‰ã€ä¿¡è³´æ°´æº–ï¼ˆä½ è¦å¤šä¿å®ˆï¼Ÿï¼‰")

confidence_level = st.selectbox(
    "ä¿¡è³´æ°´æº–",
    [0.90, 0.95, 0.99],
    index=1
)

alpha = 1 - confidence_level

# =================================================
# E. ä¿¡è³´å€é–“è¨ˆç®—
# =================================================
if case != "æ–½å·¥å“è³ªåˆæ ¼ç‡":
    xbar = np.mean(sample)
    s = np.std(sample, ddof=1)
    t_crit = t.ppf(1 - alpha / 2, df=sample_size - 1)
    margin = t_crit * s / np.sqrt(sample_size)
    lower, upper = xbar - margin, xbar + margin
else:
    phat = np.mean(sample)
    z = t.ppf(1 - alpha / 2, df=sample_size - 1)
    margin = z * np.sqrt(phat * (1 - phat) / sample_size)
    lower, upper = phat - margin, phat + margin

# =================================================
# F. è¦–è¦ºåŒ–
# =================================================
st.subheader("å››ã€ä¿¡è³´å€é–“è¦–è¦ºåŒ–")

fig, ax = plt.subplots()

ax.axvline(safety_limit, color="red", linestyle="--", label="å·¥ç¨‹å®‰å…¨é–€æª»")
ax.hlines(1, lower, upper, color="blue", linewidth=4)
ax.plot([np.mean(sample)], [1], "o", label="æ¨£æœ¬å¹³å‡")

ax.set_yticks([])
ax.set_xlabel(f"å·¥ç¨‹é‡ ({unit})")
ax.legend()
st.pyplot(fig, use_container_width=True)

# =================================================
# G. å·¥ç¨‹åˆ¤æ–·
# =================================================
st.subheader("äº”ã€å·¥ç¨‹åˆ¤æ–·")

if lower <= safety_limit <= upper:
    st.warning("""
âš ï¸ **ä¿¡è³´å€é–“è·¨è¶Šå®‰å…¨é–€æª»**

åœ¨æ­¤ä¿¡è³´æ°´æº–ä¸‹ï¼Œ  
ä½  **ç„¡æ³•æ’é™¤è¶…éå®‰å…¨é™åˆ¶çš„å¯èƒ½æ€§**ã€‚
""")
else:
    st.success("""
âœ… **ä¿¡è³´å€é–“æœªè·¨è¶Šå®‰å…¨é–€æª»**

åœ¨æ­¤ä¿¡è³´æ°´æº–ä¸‹ï¼Œ  
å·¥ç¨‹åˆ¤æ–·ç›¸å°ä¿å®ˆä¸”å¯æ¥å—ã€‚
""")

# =================================================
# å·¥ç¨‹åæ€ï¼ˆæœ€é‡è¦ï¼‰
# =================================================
st.subheader("å…­ã€å·¥ç¨‹åæ€")

st.markdown("""
è«‹å›ç­”ä»¥ä¸‹å•é¡Œï¼ˆèª²å ‚è¨è«–ï¼‰ï¼š

1. å¦‚æœä½ æŠŠä¿¡è³´æ°´æº–å¾ 95% æ”¹æˆ 99%ï¼Œæœƒç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ
2. æ¨£æœ¬æ•¸å¢åŠ ï¼Œå€é–“ä¸€å®šè®Šçª„å—ï¼Ÿ
3. åœ¨è¶•å·¥æˆ–è³‡æ–™ä¸è¶³æ™‚ï¼Œä½ æœƒé¸æ“‡æé«˜é‚„æ˜¯é™ä½ä¿¡è³´æ°´æº–ï¼Ÿ
""")

st.info("""
ğŸ“Œ æœ¬é€±é—œéµä¸æ˜¯å…¬å¼  
ğŸ“Œ è€Œæ˜¯ã€Œä½ æ•¢ç‚ºé€™å€‹å€é–“è² è²¬å—ï¼Ÿã€

ä¸‹é€±å°‡é€²å…¥ï¼š  
ğŸ‘‰ **å‡è¨­æª¢å®šï¼šå·¥ç¨‹å·®ç•°æ˜¯çœŸçš„å—ï¼Ÿ**
""")
