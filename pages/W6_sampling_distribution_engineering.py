# W6_sampling_distribution_engineering.py

import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from scipy.stats import norm, expon, weibull_min, t

st.set_page_config(layout="wide")
st.title("ç¬¬ 6 é€±ï½œæŠ½æ¨£åˆ†é…ï¼šç‚ºä»€éº¼å¹³å‡å€¼æ¯”è¼ƒå¯é ï¼Ÿ")
st.caption("ğŸ“˜ æ•™ç§‘æ›¸ç¬¬ 6 ç« ï¼ˆ6.1â€“6.4 ç‚ºä¸»ï¼‰")

st.markdown("""
å·¥ç¨‹è³‡æ–™æœ¬èº«å…·æœ‰é«˜åº¦ä¸ç¢ºå®šæ€§ï¼Œ  
ä½†å·¥ç¨‹è¨­è¨ˆå»å¸¸ä½¿ç”¨ã€Œå¹³å‡å€¼ã€ã€‚

ğŸ‘‰ ç‚ºä»€éº¼å·¥ç¨‹å¸«æ•¢é€™æ¨£åšï¼Ÿ  
ğŸ‘‰ é¢¨éšªçœŸçš„è®Šå°äº†å—ï¼Ÿ
""")

# =================================================
# A. å·¥ç¨‹ç¾è±¡é¸æ“‡
# =================================================
st.subheader("ä¸€ã€å·¥ç¨‹ç¾è±¡")

phenomenon = st.selectbox(
    "é¸æ“‡å·¥ç¨‹è³‡æ–™é¡å‹",
    ["å¡åœ°ä½ç§»", "å–®å ´é™é›¨é‡", "å…ƒä»¶å¤±æ•ˆæ™‚é–“"]
)

distribution = st.selectbox(
    "å‡è¨­æ¯é«”åˆ†é…ï¼ˆå»¶çºŒç¬¬ 5 é€±ï¼‰",
    ["å¸¸æ…‹åˆ†é…", "æŒ‡æ•¸åˆ†é…", "Weibull åˆ†é…"]
)

# =================================================
# B. æ¯é«”è¨­å®š
# =================================================
st.subheader("äºŒã€å·¥ç¨‹æ¯é«”ï¼ˆçœŸå¯¦ä½†ä½ æ°¸é çœ‹ä¸åˆ°ï¼‰")

np.random.seed(42)
N_population = 100000

if distribution == "å¸¸æ…‹åˆ†é…":
    mu = st.slider("æ¯é«”å¹³å‡å€¼ Î¼", 0.0, 200.0, 100.0)
    sigma = st.slider("æ¯é«”æ¨™æº–å·® Ïƒ", 1.0, 50.0, 20.0)
    population = np.random.normal(mu, sigma, N_population)

elif distribution == "æŒ‡æ•¸åˆ†é…":
    lam = st.slider("å¤±æ•ˆç‡ Î»", 0.01, 1.0, 0.1)
    population = np.random.exponential(1 / lam, N_population)

else:
    shape = st.slider("å½¢ç‹€åƒæ•¸ k", 0.5, 5.0, 1.5)
    scale = st.slider("å°ºåº¦åƒæ•¸ Î»", 1.0, 50.0, 15.0)
    population = weibull_min.rvs(shape, scale=scale, size=N_population)

# =================================================
# C. æŠ½æ¨£è¨­å®š
# =================================================
st.subheader("ä¸‰ã€ä½ å¯¦éš›èƒ½å–å¾—å¤šå°‘è³‡æ–™ï¼Ÿ")

sample_size = st.slider("æ¯æ¬¡æŠ½æ¨£çš„æ¨£æœ¬æ•¸ n", 2, 100, 10)
n_repeat = st.slider("é‡è¤‡æŠ½æ¨£æ¬¡æ•¸", 100, 5000, 1000)

sample_means = []

for _ in range(n_repeat):
    sample = np.random.choice(population, sample_size, replace=False)
    sample_means.append(sample.mean())

sample_means = np.array(sample_means)

# =================================================
# D. è¦–è¦ºåŒ–æ¯”è¼ƒ
# =================================================
st.subheader("å››ã€æ¯é«” vs æŠ½æ¨£å¹³å‡çš„åˆ†å¸ƒ")

col1, col2 = st.columns(2)

with col1:
    fig1, ax1 = plt.subplots()
    ax1.hist(population, bins=50, density=True)
    ax1.set_title("å·¥ç¨‹æ¯é«”åˆ†å¸ƒï¼ˆä½ çœ‹ä¸åˆ°ï¼‰")
    st.pyplot(fig1)

with col2:
    fig2, ax2 = plt.subplots()
    ax2.hist(sample_means, bins=30, density=True)
    ax2.set_title("æ¨£æœ¬å¹³å‡çš„åˆ†å¸ƒ")
    st.pyplot(fig2)

# =================================================
# E. å·¥ç¨‹è§£è®€ï¼ˆæ ¸å¿ƒï¼‰
# =================================================
st.subheader("äº”ã€å·¥ç¨‹çµ±è¨ˆè§£è®€")

st.metric(
    "æ¨£æœ¬å¹³å‡çš„æ¨™æº–å·®ï¼ˆæ¨™æº–èª¤ï¼‰",
    f"{np.std(sample_means):.3f}"
)

st.warning(f"""
è§€å¯Ÿé‡é»ï¼š
1. å³ä½¿æ¯é«”éå¸¸åæ…‹ï¼Œæ¨£æœ¬å¹³å‡çš„åˆ†å¸ƒæœƒè®Šå¾—è¼ƒé›†ä¸­
2. æ¨£æœ¬æ•¸ n = {sample_size}ï¼Œæ¨£æœ¬å¹³å‡çš„è®Šç•°å·²æ˜é¡¯å°æ–¼æ¯é«”
3. é€™å°±æ˜¯å·¥ç¨‹å¸«æ•¢ç”¨ã€Œå¹³å‡å€¼ã€çš„ç†ç”±
""")

# =================================================
# F. Student-t çš„å·¥ç¨‹ç›´è¦ºï¼ˆä¸æ¨å…¬å¼ï¼‰
# =================================================
st.subheader("å…­ã€æ¨£æœ¬å°‘æ™‚ï¼Œç‚ºä»€éº¼è¦æ›´ä¿å®ˆï¼Ÿï¼ˆt åˆ†é…æ¦‚å¿µï¼‰")

df = sample_size - 1
x = np.linspace(-4, 4, 400)

fig3, ax3 = plt.subplots()
ax3.plot(x, norm.pdf(x), label="å¸¸æ…‹åˆ†é…")
ax3.plot(x, t.pdf(x, df), linestyle="--", label=f"t åˆ†é… (df={df})")
ax3.legend()
ax3.set_title("æ¨£æœ¬å°‘ â†’ å°¾å·´è®Šåš")
st.pyplot(fig3)

st.info("""
ğŸ“Œ å·¥ç¨‹æ„ç¾©ï¼š
- æ¨£æœ¬å°‘ â†’ ä¸ç¢ºå®šæ€§å¤§
- çµ±è¨ˆä¸æ˜¯æ‡²ç½°ä½ ï¼Œè€Œæ˜¯æé†’ä½ è¦ä¿å®ˆ
""")

# =================================================
# å·¥ç¨‹æ±ºç­–åæ€
# =================================================
st.subheader("ä¸ƒã€å·¥ç¨‹æ±ºç­–åæ€")

st.markdown("""
æ€è€ƒå•é¡Œï¼š
1. åœ¨ä½ çš„å·¥ç¨‹æ¡ˆä¾‹ä¸­ï¼Œæ¨£æœ¬é€šå¸¸æœ‰å¤šå°‘ï¼Ÿ
2. ä½ æœƒæ”¾å¿ƒç”¨å¹³å‡å€¼å—ï¼Ÿ
3. è‹¥æ¨£æœ¬æ•¸ç„¡æ³•å¢åŠ ï¼Œä½ èƒ½æ€éº¼é™ä½é¢¨éšªï¼Ÿ
""")
