# W6_sampling_distribution_engineering.py
# æŸ¥è¡¨å°å‘ç‰ˆ

import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from scipy.stats import norm, expon, weibull_min, t

st.set_page_config(layout="wide")
st.title("ç¬¬ 6 é€±ï½œæŠ½æ¨£åˆ†é…èˆ‡ t è¡¨ï¼ˆå·¥ç¨‹æŸ¥è¡¨è¨“ç·´ï¼‰")
st.caption("ğŸ“˜ æ•™ç§‘æ›¸ç¬¬ 6 ç« ï½œæœ¬é€±é‡é»ï¼šæœƒæŸ¥è¡¨")

# =================================================
# A. å­¸ç¿’æ¨¡å¼
# =================================================
st.sidebar.header("å­¸ç¿’æ¨¡å¼")

mode = st.sidebar.radio(
    "é¸æ“‡æ¨¡å¼",
    ["ğŸ” æŸ¥è¡¨ç·´ç¿’æ¨¡å¼ï¼ˆèª²å ‚ï¼‰", "âš¡ è‡ªå‹•é©—è­‰æ¨¡å¼ï¼ˆèª²å¾Œï¼‰"]
)

st.markdown("""
å·¥ç¨‹å¸«ä¸æ˜¯æ¯æ¬¡éƒ½æœ‰é›»è…¦ã€‚

ğŸ‘‰ æœ¬é€±ä½ è¦å­¸çš„æ˜¯ï¼š  
**çœ‹åˆ°æ¨£æœ¬æ•¸ â†’ çŸ¥é“ df â†’ æŸ¥ t è¡¨ â†’ åšåˆ¤æ–·**
""")

# =================================================
# B. å·¥ç¨‹æ¯é«”è¨­å®šï¼ˆå»¶çºŒç¬¬ 5 é€±ï¼‰
# =================================================
st.subheader("ä¸€ã€å·¥ç¨‹æ¯é«”ï¼ˆä½ æ°¸é çœ‹ä¸åˆ°ï¼‰")

distribution = st.selectbox(
    "å‡è¨­å·¥ç¨‹è³‡æ–™åˆ†é…",
    ["å¸¸æ…‹åˆ†é…", "æŒ‡æ•¸åˆ†é…", "Weibull åˆ†é…"]
)

np.random.seed(42)
N_population = 100000

if distribution == "å¸¸æ…‹åˆ†é…":
    mu = st.slider("æ¯é«”å¹³å‡ Î¼", 0.0, 200.0, 100.0)
    sigma = st.slider("æ¯é«”æ¨™æº–å·® Ïƒ", 1.0, 50.0, 20.0)
    population = np.random.normal(mu, sigma, N_population)

elif distribution == "æŒ‡æ•¸åˆ†é…":
    lam = st.slider("å¤±æ•ˆç‡ Î»", 0.01, 1.0, 0.1)
    population = np.random.exponential(1 / lam, N_population)

else:
    shape = st.slider("å½¢ç‹€åƒæ•¸ k", 0.5, 5.0, 1.5)
    scale = st.slider("å°ºåº¦åƒæ•¸ Î»", 1.0, 50.0, 15.0)
    population = weibull_min.rvs(shape, scale=scale, size=N_population)

# =================================================
# C. æŠ½æ¨£è¨­å®š
# =================================================
st.subheader("äºŒã€æŠ½æ¨£")

sample_size = st.slider("æ¨£æœ¬æ•¸ n", 5, 60, 10)
n_repeat = st.slider("é‡è¤‡æŠ½æ¨£æ¬¡æ•¸", 200, 3000, 1000)

df = sample_size - 1
st.write(f"ğŸ‘‰ è‡ªç”±åº¦ df = n âˆ’ 1 = **{df}**")

# =================================================
# D. é‡è¤‡æŠ½æ¨£
# =================================================
sample_means = []

for _ in range(n_repeat):
    sample = np.random.choice(population, sample_size, replace=False)
    sample_means.append(sample.mean())

sample_means = np.array(sample_means)

# =================================================
# E. æŠ½æ¨£åˆ†é…è¦–è¦ºåŒ–
# =================================================
st.subheader("ä¸‰ã€æ¨£æœ¬å¹³å‡çš„åˆ†å¸ƒ")

fig, ax = plt.subplots()
ax.hist(sample_means, bins=30, density=True)
ax.set_title("æ¨£æœ¬å¹³å‡çš„æŠ½æ¨£åˆ†é…")
st.pyplot(fig)

# =================================================
# F. æŸ¥è¡¨å€ï¼ˆæ ¸å¿ƒï¼‰
# =================================================
st.subheader("å››ã€t è¡¨æŸ¥è¡¨ç·´ç¿’")

confidence = st.selectbox(
    "ä¿¡è³´æ°´æº–",
    [0.90, 0.95, 0.99],
    index=1
)

alpha = 1 - confidence
st.write(f"ğŸ‘‰ Î± = {alpha}")
st.write(f"ğŸ‘‰ Î±/2 = {alpha/2}")

st.markdown("""
ğŸ“˜ **è«‹æ‰“é–‹æ•™ç§‘æ›¸å¾Œé¢çš„ t è¡¨**  
ä¾æ“šï¼š
- df = n âˆ’ 1  
- Î±/2  

æŸ¥å‡º t å€¼
""")

t_input = st.number_input(
    "è«‹è¼¸å…¥ä½ æŸ¥åˆ°çš„ tÎ±/2, df",
    value=2.0,
    step=0.01
)

# =================================================
# G. é©—è­‰ï¼ˆæ˜¯å¦é¡¯ç¤ºç­”æ¡ˆï¼‰
# =================================================
t_true = t.ppf(1 - alpha / 2, df)

if mode == "âš¡ è‡ªå‹•é©—è­‰æ¨¡å¼ï¼ˆèª²å¾Œï¼‰":
    st.write(f"ğŸ“Œ æ­£ç¢º t å€¼ â‰ˆ **{t_true:.3f}**")

    if abs(t_input - t_true) < 0.05:
        st.success("âœ… æŸ¥è¡¨æ­£ç¢º")
    else:
        st.warning("âš ï¸ è«‹å†ç¢ºèª df æˆ– Î±/2")

else:
    st.info("""
ğŸ“Œ èª²å ‚æ¨¡å¼ä¸é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ  
ğŸ“Œ è€å¸«æœƒè«‹ä½ èªªæ˜ã€Œç‚ºä»€éº¼ç”¨é€™å€‹ t å€¼ã€
""")

# =================================================
# H. å·¥ç¨‹æ„ç¾©
# =================================================
st.subheader("äº”ã€å·¥ç¨‹æ„ç¾©")

st.markdown(f"""
- æ¨£æœ¬æ•¸ n = {sample_size}  
- df = {df}  

ğŸ‘‰ df è¶Šå°ï¼Œt å€¼è¶Šå¤§  
ğŸ‘‰ ä»£è¡¨å·¥ç¨‹ä¸ç¢ºå®šæ€§è¶Šé«˜  
ğŸ‘‰ çµ±è¨ˆåœ¨æé†’ä½ ã€Œè¦æ›´ä¿å®ˆã€
""")

st.warning("""
âš ï¸ è«‹è¨˜ä½ï¼š  
çµ±è¨ˆä¸æ˜¯è®“ä½ æ›´å†’éšª  
è€Œæ˜¯è®“ä½ çŸ¥é“ã€Œä½ å†’äº†å¤šå¤§çš„éšªã€
""")
