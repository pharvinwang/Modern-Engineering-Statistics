# W9_hypothesis_testing_engineering.py

import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from scipy.stats import t, norm

st.set_page_config(layout="wide")
st.title("ç¬¬ 9 é€±ï½œå‡è¨­æª¢å®šï¼šå·¥ç¨‹å·®ç•°æ˜¯çœŸçš„å—ï¼Ÿ")
st.caption("ğŸ“˜ æ•™ç§‘æ›¸ç¬¬ 8 ç« ï¼ˆ8.1â€“8.4ï¼‰")

st.markdown("""
å·¥ç¨‹ç¾å ´ç¶“å¸¸é¢è‡¨æ¯”è¼ƒï¼š

- æ–°å·¥æ³•çœŸçš„æ¯”è¼ƒå¥½ï¼Ÿ
- æ”¹è¨­è¨ˆå¾Œä½ç§»çœŸçš„è®Šå°ï¼Ÿ
- æ–½å·¥å“è³ªçœŸçš„æ”¹å–„ï¼Ÿ

ğŸ‘‰ çµ±è¨ˆä¸æ˜¯çµ¦ç­”æ¡ˆ  
ğŸ‘‰ æ˜¯å‘Šè¨´ä½ ã€Œè­‰æ“šå¤ ä¸å¤ ã€
""")

# =================================================
# A. å·¥ç¨‹æ¯”è¼ƒæƒ…å¢ƒ
# =================================================
st.subheader("ä¸€ã€å·¥ç¨‹æ¯”è¼ƒæƒ…å¢ƒ")

case = st.selectbox(
    "é¸æ“‡å·¥ç¨‹æ¡ˆä¾‹",
    ["å¡åœ°ç©©å®šæ”¹å–„å‰å¾Œ", "æ–°èˆŠæ–½å·¥å·¥æ³•", "æ–½å·¥å“è³ªåˆæ ¼ç‡æ¯”è¼ƒ"]
)

np.random.seed(42)

# =================================================
# B. æ¨¡æ“¬å·¥ç¨‹è³‡æ–™
# =================================================
if case == "å¡åœ°ç©©å®šæ”¹å–„å‰å¾Œ":
    before = np.random.normal(3.2, 0.6, 40)
    after = np.random.normal(2.7, 0.6, 40)
    unit = "mm"
    H0 = "æ”¹å–„å‰å¾Œå¹³å‡ä½ç§»ç›¸åŒ"
    H1 = "æ”¹å–„å¾Œå¹³å‡ä½ç§»è¼ƒå°"

elif case == "æ–°èˆŠæ–½å·¥å·¥æ³•":
    before = np.random.normal(28, 4, 35)
    after = np.random.normal(25, 4, 35)
    unit = "åˆ†é˜"
    H0 = "æ–°èˆŠå·¥æ³•å¹³å‡æ–½å·¥æ™‚é–“ç›¸åŒ"
    H1 = "æ–°å·¥æ³•æ–½å·¥æ™‚é–“è¼ƒçŸ­"

else:
    before = np.random.binomial(1, 0.88, 60)
    after = np.random.binomial(1, 0.94, 60)
    unit = "%"
    H0 = "å…©å·¥æ³•åˆæ ¼ç‡ç›¸åŒ"
    H1 = "æ–°å·¥æ³•åˆæ ¼ç‡è¼ƒé«˜"

# =================================================
# C. é¡¯ç¤ºå·¥ç¨‹å‡è¨­
# =================================================
st.subheader("äºŒã€å·¥ç¨‹å‡è¨­")

st.write("**è™›ç„¡å‡è¨­ Hâ‚€ï¼š**", H0)
st.write("**å°ç«‹å‡è¨­ Hâ‚ï¼š**", H1)

# =================================================
# D. é¡¯è‘—æ°´æº–
# =================================================
st.subheader("ä¸‰ã€ä½ è¦å¤šåš´æ ¼ï¼Ÿ")

alpha = st.selectbox("é¡¯è‘—æ°´æº– Î±", [0.10, 0.05, 0.01], index=1)

# =================================================
# E. æª¢å®šè¨ˆç®—
# =================================================
if case != "æ–½å·¥å“è³ªåˆæ ¼ç‡æ¯”è¼ƒ":
    mean_diff = np.mean(after) - np.mean(before)
    pooled_se = np.sqrt(np.var(before, ddof=1)/len(before) +
                         np.var(after, ddof=1)/len(after))
    t_stat = mean_diff / pooled_se
    df = len(before) + len(after) - 2
    p_value = t.cdf(t_stat, df)
else:
    p1, p2 = np.mean(before), np.mean(after)
    p_pool = (sum(before) + sum(after)) / (len(before) + len(after))
    z_stat = (p2 - p1) / np.sqrt(p_pool*(1-p_pool)*(1/len(before)+1/len(after)))
    p_value = norm.cdf(z_stat)

# =================================================
# F. è¦–è¦ºåŒ–è­‰æ“š
# =================================================
st.subheader("å››ã€è­‰æ“šè¦–è¦ºåŒ–")

fig, ax = plt.subplots()
ax.bar(["æ”¹å–„å‰", "æ”¹å–„å¾Œ"], [np.mean(before), np.mean(after)])
ax.set_ylabel(unit)
ax.set_title("å·¥ç¨‹å¹³å‡å€¼æ¯”è¼ƒ")
st.pyplot(fig)

# =================================================
# G. å·¥ç¨‹åˆ¤æ–·
# =================================================
st.subheader("äº”ã€å·¥ç¨‹æ±ºç­–")

st.write(f"**p-value = {p_value:.4f}**")

if p_value < alpha:
    st.success("""
âœ… è­‰æ“šè¶³å¤ å¼·  
å¯ä»¥æ‹’çµ•è™›ç„¡å‡è¨­

ğŸ‘‰ å·¥ç¨‹å·®ç•°ã€Œä¸æ˜¯å¶ç„¶ã€
""")
else:
    st.warning("""
âš ï¸ è­‰æ“šä¸è¶³  
ç„¡æ³•æ‹’çµ•è™›ç„¡å‡è¨­

ğŸ‘‰ ä¸èƒ½èªªå·¥ç¨‹çœŸçš„ä¸åŒ
""")

# =================================================
# å·¥ç¨‹åæ€ï¼ˆæœ€é‡è¦ï¼‰
# =================================================
st.subheader("å…­ã€å·¥ç¨‹åæ€")

st.markdown("""
è«‹è¨è«–ï¼š

1. p-value å°ä»£è¡¨ã€Œå·®ç•°å¤§ã€å—ï¼Ÿ
2. å¦‚æœæ¨£æœ¬æ•¸ç¿»å€ï¼Œçµæœæœƒè®Šå—ï¼Ÿ
3. åœ¨é«˜é¢¨éšªå·¥ç¨‹ä¸­ï¼Œä½ æœƒé¸æ“‡ Î± = 0.1 é‚„æ˜¯ 0.01ï¼Ÿ
""")

st.info("""
ğŸ“Œ å‡è¨­æª¢å®šä¸æ˜¯è­‰æ˜  
ğŸ“Œ æ˜¯è©•ä¼°è­‰æ“š

ä¸‹ä¸€é€±å°‡é€²å…¥ï¼š  
ğŸ‘‰ **è®Šç•°æ•¸åˆ†æï¼ˆå¤šæ–¹æ¡ˆæ¯”è¼ƒï¼‰**
""")
