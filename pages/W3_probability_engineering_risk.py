# W3_probability_engineering_risk.py

import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

st.set_page_config(layout="wide")
st.title("ç¬¬ 3 é€±ï½œæ©Ÿç‡ã€é¢¨éšªèˆ‡å·¥ç¨‹åˆ¤æ–·")
st.caption("ğŸ“˜ æ•™ç§‘æ›¸ç¬¬ 3 ç« ï¼ˆ3.1â€“3.5ï¼‰")

st.markdown("""
å·¥ç¨‹ä¸­çš„ã€Œæ©Ÿç‡ã€ä¸æ˜¯è³­åšï¼Œ  
è€Œæ˜¯ç”¨ä¾†æè¿° **åœ¨ä¸ç¢ºå®šç’°å¢ƒä¸­ï¼Œå·¥ç¨‹å¤±æ•—çš„å¯èƒ½æ€§**ã€‚
""")

# -------------------------------------------------
# A. å·¥ç¨‹æƒ…å¢ƒé¸æ“‡
# -------------------------------------------------
st.subheader("ä¸€ã€å·¥ç¨‹é¢¨éšªæƒ…å¢ƒ")

case = st.selectbox(
    "é¸æ“‡å·¥ç¨‹æ¡ˆä¾‹",
    [
        "å¡åœ°ä½ç§»è¶…éè­¦æˆ’å€¼",
        "å–®å ´é™é›¨è¶…éè¨­è¨ˆé›¨é‡",
        "æ–½å·¥å“è³ªæœªé”è¦ç¯„"
    ]
)

# -------------------------------------------------
# B. è¨­å®šå·¥ç¨‹é–€æª»ï¼ˆäº‹ä»¶å®šç¾©ï¼‰
# -------------------------------------------------
st.subheader("äºŒã€å·¥ç¨‹å¤±æ•—äº‹ä»¶å®šç¾©")

if case == "å¡åœ°ä½ç§»è¶…éè­¦æˆ’å€¼":
    unit = "mm"
    threshold = st.slider("ä½ç§»è­¦æˆ’å€¼", 1.0, 5.0, 3.0)
    data = np.random.normal(2.5, 0.6, 200)

elif case == "å–®å ´é™é›¨è¶…éè¨­è¨ˆé›¨é‡":
    unit = "mm"
    threshold = st.slider("è¨­è¨ˆé›¨é‡é–€æª»", 80, 200, 120)
    data = np.random.normal(110, 25, 200)

else:
    unit = "%"
    threshold = st.slider("æœ€ä½åˆæ ¼å¤¯å¯¦åº¦", 85, 100, 95)
    data = np.random.normal(94, 3, 200)

df = pd.DataFrame({"value": data})

# -------------------------------------------------
# C. æ¢ä»¶è¨­å®šï¼ˆå·¥ç¨‹æ¢ä»¶ï¼‰
# -------------------------------------------------
st.subheader("ä¸‰ã€å·¥ç¨‹æ¢ä»¶ï¼ˆæ¢ä»¶æ©Ÿç‡æ¦‚å¿µï¼‰")

condition = st.checkbox("è€ƒæ…®ä¸åˆ©æ¢ä»¶ï¼ˆå¦‚è±ªé›¨æœŸ / è»Ÿå¼±åœ°å±¤ / è¶•å·¥ï¼‰")

if condition:
    df["value"] += np.random.normal(0.5, 0.3, len(df))

# -------------------------------------------------
# D. æ©Ÿç‡è¨ˆç®—
# -------------------------------------------------
st.subheader("å››ã€å·¥ç¨‹é¢¨éšªé‡åŒ–")

if case == "æ–½å·¥å“è³ªæœªé”è¦ç¯„":
    failure_prob = np.mean(df["value"] < threshold)
else:
    failure_prob = np.mean(df["value"] > threshold)

st.metric("ä¼°è¨ˆå¤±æ•—æ©Ÿç‡", f"{failure_prob:.2%}")

# -------------------------------------------------
# E. è¦–è¦ºåŒ–
# -------------------------------------------------
fig, ax = plt.subplots()
ax.hist(df["value"], bins=20, edgecolor="black")
ax.axvline(threshold, color="red", linestyle="--", label="å·¥ç¨‹é–€æª»")
ax.legend()
st.pyplot(fig, use_container_width=True)

# -------------------------------------------------
# F. ç³»çµ±é¢¨éšªï¼ˆè¤‡åˆäº‹ä»¶ï¼‰
# -------------------------------------------------
st.subheader("äº”ã€è¤‡åˆå·¥ç¨‹é¢¨éšªï¼ˆç³»çµ±æ¦‚å¿µï¼‰")

st.markdown("""
å‡è¨­å·¥ç¨‹å¤±æ•—éœ€åŒæ™‚ç™¼ç”Ÿä»¥ä¸‹äº‹ä»¶ï¼š
- Aï¼šé™é›¨è¶…éé–€æª»
- Bï¼šæ’æ°´åŠŸèƒ½ä¸è¶³
""")

pA = st.slider("P(A)ï¼šé™é›¨è¶…æ¨™æ©Ÿç‡", 0.0, 1.0, 0.3)
pB = st.slider("P(B)ï¼šæ’æ°´å¤±æ•ˆæ©Ÿç‡", 0.0, 1.0, 0.2)

system_failure = pA * pB
st.metric("ç³»çµ±å¤±æ•—æ©Ÿç‡ P(A âˆ© B)", f"{system_failure:.2%}")

# -------------------------------------------------
# G. å·¥ç¨‹æ±ºç­–åæ€
# -------------------------------------------------
st.subheader("å…­ã€å·¥ç¨‹æ±ºç­–åæ€")

st.warning(f"""
ä½ ç¾åœ¨çœ‹åˆ°çš„æ˜¯ã€Œä¼°è¨ˆçš„é¢¨éšªã€ï¼Œä¸æ˜¯ç¢ºå®šçµæœã€‚

æ€è€ƒå•é¡Œï¼š
1. é€™å€‹å¤±æ•—æ©Ÿç‡ä½ èƒ½æ¥å—å—ï¼Ÿ
2. è‹¥ä¸å¯æ¥å—ï¼Œä½ èƒ½æ”¹å–„å“ªå€‹æ¢ä»¶ï¼Ÿ
3. æ˜¯é™ä½ P(A) é‚„æ˜¯ P(B) æ¯”è¼ƒæœ‰æ•ˆï¼Ÿ
""")

st.info("""
ğŸ“Œ æœ¬é€±é‡é»ä¸æ˜¯ç®—å…¬å¼  
ğŸ“Œ è€Œæ˜¯å»ºç«‹ã€Œå·¥ç¨‹é¢¨éšªèªè¨€ã€

å¾ŒçºŒç« ç¯€ï¼Œæˆ‘å€‘æœƒæ•™ä½ ï¼š
- å¦‚ä½•æ›´æº–ç¢º
